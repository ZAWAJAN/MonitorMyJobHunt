<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<title>My Job Application Journey</title>
		<style>
			html,
			body,
			#graph-container {
				height: 100%;
				margin: 0;
				padding: 0;
			}
		</style>
	</head>

	<body>
		<div id="last-updated" style="padding: 10px; font-size: 0.8em; color: gray;"></div>
		<div id="graph-container"></div>

		<script>
			(function loadPlotly() {
				var cdn = 'https://cdn.plot.ly/plotly-2.35.2.min.js';
				var local = 'plotly.local.min.js';
				function load(src, cb, err) {
					var s = document.createElement('script');
					s.src = src; s.onload = cb; s.onerror = err;
					document.head.appendChild(s);
				}
				load(cdn, () => initGraph(), () => load(local, () => initGraph()));
			})();

			// 1. GLOBAL CONFIGURATION OBJECTS
			// Edit these to change the look without touching the logic below
			const chartStyle = {
				node: {
					pad: 20,
					thickness: 15,
					line: { color: "#2c3e50", width: 0.5 },
					color: "#3498db" // Professional blue
				},
				link: {
					color: "rgba(52, 152, 219, 0.3)" // Transparent blue for flows
				}
			};

			const chartLayout = {
				title: {
					text: "Job Application Journey 2026",
					font: { size: 24, family: "Arial, sans-serif" },
					x: 0.05
				},
				font: { size: 12, family: "Segoe UI, Tahoma, sans-serif" },
				margin: { l: 50, r: 50, t: 80, b: 50 },
				paper_bgcolor: "#ffffff",
				plot_bgcolor: "#f8f9fa"
			};

			async function initGraph() {
				try {
					const version = new Date().getTime();
					const response = await fetch(`sankey_data.json?v=${version}`);
					if (!response.ok) throw new Error('Network response was not ok');

					const data = await response.json();
					if (data.last_updated) {
						document.getElementById('last-updated').innerText = `Data last updated: ${data.last_updated}`;
					}

					// 2. MERGE DATA WITH CONFIG
					const trace = {
						type: "sankey",
						orientation: "h",
						node: {
							...chartStyle.node, // Spread operator copies the config
							label: data.labels,
							x: data.node_x,
						},
						link: {
							...chartStyle.link, // Spread operator copies the config
							source: data.sources,
							target: data.targets,
							value: data.values,
							color: data.link_colors,
							customdata: data.link_colors
						}
					};

					const config = {
						responsive: true,
						displayModeBar: false // Keeps the UI clean
					};

					Plotly.newPlot('graph-container', [trace], chartLayout, config);

					// 3. INTERACTIVITY: HOVER TO HIGHLIGHT PATHS
					gd.on('plotly_hover', function (eventData) {
						const hovered = eventData.points[0];
						const newColors = [...data.link_colors];

						if (hovered.source) {
							// Logic if hovering a link: highlight just that path
							// Logic if hovering a node: highlight all paths connected to it
							highlightPath(hovered, newColors, data);
						}

						Plotly.restyle(gd, { 'link.color': [newColors] }, [0]);
					});

					gd.on('plotly_unhover', function () {
						// Reset to original colors
						Plotly.restyle(gd, { 'link.color': [data.link_colors] }, [0]);
					});

				} catch (err) {
					console.error('Error loading data:', err);
				}
			}

			function highlightPath(point, colors, rawData) {
				// This helper function recursively finds connected links
				// and changes their opacity to 1.0 while dimming others to 0.1
				const activeLinks = findConnectedLinks(point, rawData);

				for (let i = 0; i < colors.length; i++) {
					if (activeLinks.includes(i)) {
						colors[i] = colors[i].replace(/0\.\d+\)/, "0.8)"); // Brighten
					} else {
						colors[i] = colors[i].replace(/0\.\d+\)/, "0.05)"); // Dim
					}
				}
			}
		</script>
	</body>

</html>